{{ $servicePortMap := default dict }}
{{- range $name, $config := .Values.components }}
    {{ if $config.ports }}
        {{- $servicePortMap := set $servicePortMap  $name (get (index $config.ports 0 ) "value") }}
    {{- end}}
    {{ if $config.servicePort }}
        {{- $servicePortMap := set $servicePortMap  $name $config.servicePort }}
    {{- end}}
{{- end }}

{{- range $name, $config := .Values.components }}
    {{- $config := set . "name" $name }}
    {{- $config := set . "Release" $.Release }}
    {{- $config := set . "Chart" $.Chart }}
    {{- $config := set . "imageConfig" $.Values.image }}
    {{- $config := set . "serviceAccount" $.Values.serviceAccount }}
    {{- $config := set . "observability" $.Values.observability }}
    {{- $config := set . "servicePortMap" $servicePortMap }}

    {{- if $config.enabled -}}
        {{- include "otel.demo.deployment" $config -}}
        {{- include "otel.demo.service" $config -}}
    {{ end }}

{{- end }}
